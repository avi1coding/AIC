'use server';

/**
 * @fileOverview AI-powered homework analysis flow for text input.
 *
 * - analyzeHomeworkText - Analyzes the provided text to detect potential AI generation.
 * - AnalyzeHomeworkTextInput - The input type for the analyzeHomeworkText function.
 * - AnalyzeHomeworkTextOutput - The return type for the analyzeHomeworkText function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';

const AnalyzeHomeworkTextInputSchema = z.object({
  text: z
    .string()
    .describe('The homework text to analyze for potential AI generation.'),
});
export type AnalyzeHomeworkTextInput = z.infer<typeof AnalyzeHomeworkTextInputSchema>;

const AnalyzeHomeworkTextOutputSchema = z.object({
  isAiGenerated: z
    .boolean()
    .describe('Whether the homework text was likely generated by AI.'),
  confidenceScore: z
    .number()
    .describe(
      'A score (0-1) indicating the confidence level of AI generation detection.'
    ),
  explanation: z
    .string()
    .describe('A brief explanation for the given confidence score.'),
});
export type AnalyzeHomeworkTextOutput = z.infer<typeof AnalyzeHomeworkTextOutputSchema>;

export async function analyzeHomeworkText(
  input: AnalyzeHomeworkTextInput
): Promise<AnalyzeHomeworkTextOutput> {
  return analyzeHomeworkTextFlow(input);
}

const analyzeHomeworkTextPrompt = ai.definePrompt({
  name: 'analyzeHomeworkTextPrompt',
  input: {schema: AnalyzeHomeworkTextInputSchema},
  output: {schema: AnalyzeHomeworkTextOutputSchema},
  config: {
    temperature: 0.2,
  },
  prompt: `You are a highly discerning AI Writing Detection Expert. Your primary task is to analyze a piece of text and determine the likelihood that it was generated by an AI. You must be deeply critical and skeptical, especially of text that seems too perfect or uses sophisticated vocabulary and sentence structures without a clear, authentic voice.

Human writing often has:
- A distinct, sometimes inconsistent, personal style or voice. It has personality.
- Occasional use of idioms, colloquialisms, or slightly awkward phrasing. It is not always perfect.
- Rhythmic and structural variation in sentences that feels natural, not formulaic.
- A clear, though not always perfectly articulated, point of view or emotional tone.

AI writing, even when "humanized," often exhibits:
- Very consistent, overly polished, and perfectly structured prose that lacks a unique, personal voice.
- A tendency to use complex words and sentence structures that feel unnaturally uniform.
- A descriptive and explanatory tone without a strong underlying opinion or authentic emotion.
- A lack of the minor imperfections and stylistic quirks that characterize human writing.

Analyze the following homework text with these nuances in mind. Be very critical. If the text seems too polished or lacks a distinct personality, it is likely AI-generated.

'''
{{{text}}}
'''

Based on your detailed analysis, determine:
1.  **isAiGenerated**: A boolean value (true/false). Set this to true ONLY if you have high confidence the text is AI-generated. Err on the side of detecting AI. A "humanized" text is still an AI text.
2.  **confidenceScore**: A score between 0.0 and 1.0. A score of 1.0 means you are 100% certain it is AI-generated. A score below 0.5 suggests it is *likely* human-written, but only if it has clear human-like imperfections. Your score should reflect a high degree of skepticism.
3.  **explanation**: A brief, critical explanation of your reasoning. If you suspect AI, cite specific examples of polished prose, lack of voice, or other AI tells. If you believe it's human, point to stylistic choices, voice, or minor imperfections that strongly support your conclusion.
`,
});

const analyzeHomeworkTextFlow = ai.defineFlow(
  {
    name: 'analyzeHomeworkTextFlow',
    inputSchema: AnalyzeHomeworkTextInputSchema,
    outputSchema: AnalyzeHomeworkTextOutputSchema,
  },
  async input => {
    const {output} = await analyzeHomeworkTextPrompt(input);
    return output!;
  }
);
