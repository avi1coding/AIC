'use server';

/**
 * @fileOverview AI-powered homework analysis flow for text input.
 *
 * - analyzeHomeworkText - Analyzes the provided text to detect potential AI generation.
 * - AnalyzeHomeworkTextInput - The input type for the analyzeHomeworkText function.
 * - AnalyzeHomeworkTextOutput - The return type for the analyzeHomeworkText function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';

const AnalyzeHomeworkTextInputSchema = z.object({
  text: z
    .string()
    .describe('The homework text to analyze for potential AI generation.'),
});
export type AnalyzeHomeworkTextInput = z.infer<typeof AnalyzeHomeworkTextInputSchema>;

const AnalyzeHomeworkTextOutputSchema = z.object({
  isAiGenerated: z
    .boolean()
    .describe('Whether the homework text was likely generated by AI.'),
  confidenceScore: z
    .number()
    .describe(
      'A score (0-1) indicating the confidence level of AI generation detection.'
    ),
  explanation: z
    .string()
    .describe('A brief explanation for the given confidence score.'),
});
export type AnalyzeHomeworkTextOutput = z.infer<typeof AnalyzeHomeworkTextOutputSchema>;

export async function analyzeHomeworkText(
  input: AnalyzeHomeworkTextInput
): Promise<AnalyzeHomeworkTextOutput> {
  return analyzeHomeworkTextFlow(input);
}

const analyzeHomeworkTextPrompt = ai.definePrompt({
  name: 'analyzeHomeworkTextPrompt',
  input: {schema: AnalyzeHomeworkTextInputSchema},
  output: {schema: AnalyzeHomeworkTextOutputSchema},
  config: {
    temperature: 0.2,
  },
  prompt: `You are an AI Writing Detection Expert. Your task is to determine if a piece of text was AI-generated.

**AI Writing Characteristics:**
*   **Overly Polished:** Uniformly perfect grammar, complex sentence structures, and a lack of a unique voice.
*   **Robotic Transitions:** Frequent use of words like "Furthermore," "Moreover," "In conclusion."
*   **Common AI Vocabulary:** Use of buzzwords like "delve," "tapestry," "leverage," "robust," "navigate."

**Human Writing Characteristics:**
*   **Natural Voice:** A distinct, sometimes inconsistent, personal style. It might have personality or a clear point of view.
*   **Simpler Language:** Often uses simpler, more direct language and sentence structures. It's not always perfect.
*   **Subtle Imperfections:** May include slightly awkward phrasing or minor grammatical errors that are common in human writing.

**IMPORTANT:** Do NOT flag text as AI-generated just because it is well-written or uses simple, clear language. Human students can be good writers. Only flag text if it shows strong, repetitive signs of being robotic, overly generic, or using common AI phrases. Be skeptical of your own judgment.

Analyze the following text:

'''
{{{text}}}
'''

Based on this, determine:
1.  **isAiGenerated**: Set to true ONLY if you are highly confident it's AI. Err on the side of it being human.
2.  **confidenceScore**: A score from 0.0 to 1.0. A score below 0.5 means it's likely human. A high score requires strong evidence.
3.  **explanation**: Briefly explain your reasoning. Cite specific examples if you suspect AI.
`,
});

const analyzeHomeworkTextFlow = ai.defineFlow(
  {
    name: 'analyzeHomeworkTextFlow',
    inputSchema: AnalyzeHomeworkTextInputSchema,
    outputSchema: AnalyzeHomeworkTextOutputSchema,
  },
  async input => {
    const {output} = await analyzeHomeworkTextPrompt(input);
    return output!;
  }
);
