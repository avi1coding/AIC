'use server';

/**
 * @fileOverview AI-powered homework analysis flow for text input.
 *
 * - analyzeHomeworkText - Analyzes the provided text to detect potential AI generation.
 * - AnalyzeHomeworkTextInput - The input type for the analyzeHomeworkText function.
 * - AnalyzeHomeworkTextOutput - The return type for the analyzeHomeworkText function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';

const AnalyzeHomeworkTextInputSchema = z.object({
  text: z
    .string()
    .describe('The homework text to analyze for potential AI generation.'),
});
export type AnalyzeHomeworkTextInput = z.infer<typeof AnalyzeHomeworkTextInputSchema>;

const AnalyzeHomeworkTextOutputSchema = z.object({
  isAiGenerated: z
    .boolean()
    .describe('Whether the homework text was likely generated by AI.'),
  confidenceScore: z
    .number()
    .describe(
      'A score (0-1) indicating the confidence level of AI generation detection.'
    ),
  explanation: z
    .string()
    .describe('A brief explanation for the given confidence score.'),
});
export type AnalyzeHomeworkTextOutput = z.infer<typeof AnalyzeHomeworkTextOutputSchema>;

export async function analyzeHomeworkText(
  input: AnalyzeHomeworkTextInput
): Promise<AnalyzeHomeworkTextOutput> {
  return analyzeHomeworkTextFlow(input);
}

const analyzeHomeworkTextPrompt = ai.definePrompt({
  name: 'analyzeHomeworkTextPrompt',
  input: {schema: AnalyzeHomeworkTextInputSchema},
  output: {schema: AnalyzeHomeworkTextOutputSchema},
  config: {
    temperature: 0.2,
  },
  prompt: `You are an expert AI Writing Detection Expert. Your primary task is to analyze a piece of text and determine the likelihood that it was generated by an AI. You must be discerning and avoid false positives.

Human writing often has:
- A distinct, sometimes inconsistent, personal style or voice.
- Occasional use of idioms, colloquialisms, or slightly awkward phrasing.
- More rhythmic and structural variation in sentences.
- A clear, though not always perfectly articulated, point of view.

AI writing often has:
- Very consistent, formal, and overly polished prose.
- A lack of a unique, personal voice.
- Perfectly structured sentences that can feel repetitive.
- A tendency to be descriptive and explanatory without a strong underlying opinion.

Analyze the following homework text with these nuances in mind:

'''
{{{text}}}
'''

Based on your detailed analysis, determine:
1.  **isAiGenerated**: A boolean value (true/false). Set this to true ONLY if you have high confidence the text is AI-generated. Err on the side of caution.
2.  **confidenceScore**: A score between 0.0 and 1.0. A score of 1.0 means you are 100% certain it is AI-generated. A score below 0.5 suggests it is likely human-written. Your score should reflect your level of certainty.
3.  **explanation**: A brief explanation of your reasoning. If you suspect AI, cite specific examples of polished prose, lack of voice, or other AI tells. If you believe it's human, point to stylistic choices, voice, or minor imperfections that support your conclusion.
`,
});

const analyzeHomeworkTextFlow = ai.defineFlow(
  {
    name: 'analyzeHomeworkTextFlow',
    inputSchema: AnalyzeHomeworkTextInputSchema,
    outputSchema: AnalyzeHomeworkTextOutputSchema,
  },
  async input => {
    const {output} = await analyzeHomeworkTextPrompt(input);
    return output!;
  }
);
